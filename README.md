# PulseChain Aggregator Contracts
Upgradeable smart contracts powering PulseChain swap aggregation with referral rewards.

## TL;DR (Quickstart)

```bash
# 1) Install dependencies
cd contracts
npm install

# 2) Generate a throwaway key for local runs (replace before mainnet)
node generateEnv.js

# 3) Compile everything
npx hardhat compile

# 4) Dry-run proxy deployment on the in-memory Hardhat network
npx hardhat run scripts/deploy-local-proxies.ts --network hardhat
```

**Requirements:** Node.js 20+, npm 10+, Git  
**Deploy to PulseChain:** `npx hardhat run scripts/deploy.ts --network pulse`

## What's Inside (Features)
- **SwapManager aggregation** - Routes swaps across PulseX, 9inch, Phux, Tide, and more using grouped multi-hop encoding.
- **Affiliate incentives** - AffiliateRouter tracks referrers, takes basis-point fees, and pays balances per token bucket.
- **Upgradeable control plane** - OpenZeppelin proxies with owner-only administration, pausable execution, and reentrancy guards.


## Installation & Setup

### Prerequisites
- **Runtime:** Node.js 20+
- **Package manager:** npm 10+
- **Infra:** PulseChain RPC endpoint (for `--network pulse` runs)

### Local Development
```bash
npm install
npx hardhat compile
```

### Configuration (ENV)
| Key | Example | Required | Description |
|---|---|:--:|---|
| `PRIVATE_KEY` | `0x0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef` | Yes* | Signer used when targeting `pulse`, `monad`, or `local` networks. |

> *Only needed outside the ephemeral Hardhat network. Keep funds on secure wallets.*

## Usage

### CLI
```bash
npx hardhat run scripts/deploy-local-proxies.ts --network pulse
npx hardhat run scripts/deploy.ts --network pulse
npx hardhat run scripts/upgrade-affiliate-router-proxy.ts --network pulse
npx hardhat console --network pulse
```

### Hardhat console snippets

```javascript
const manager = await ethers.getContractAt("SwapManager", "0xE38490Fe9866889b24CA15EBdce6F6ED06f6E8c5");

const keys = [
  "pulsexV1",
  "pulsexV2",
  "9inchV2",
  "9inchV3",
  "phux",
  "9mmV3",
  "9mmV2",
  "pulsexStable",
  "dexTop",
  "pDexV3",
  "tide",
];

const routers = [
  "0x98bf93ebf5c380C0e6Ae8e192A7e2AE08edAcc02", // PulseXV1RouterAddress
  "0x165C3410fC91EF562C50559f7d2289fEbed552d9", // PulseXV2RouterAddress
  "0xeB45a3c4aedd0F47F345fB4c8A1802BB5740d725", // nineInchV2RouterAddress
  "0x42556A17EF0Bd815bF21aD628DFd2e2f3b5F9ac7", // nineInchV3RouterAddress
  "0x7F51AC3df6A034273FB09BB29e383FCF655e473c", // PhuxVaultAddress
  "0xa9444246d80d6e3496c9242395213b4f22226a59", // nineMMRouterAddress (V3)
  "0xa9444246d80d6e3496c9242395213b4f22226a59", // nineMMRouterAddress (V2)
  "0x0000000000000000000000000000000000000001", // PulseX stable pool placeholder
  "0x1f849694Ef24a2245bCa415FE47500216B24d7FF", // dexTopRouterAddress
  "0x1eC2eaA62117486c9b2a05F098a7bF2568e19204", // pDexV3RouterAddress
  "0x634F6B9Cd1f860314871548d2224362825384B2D", // TideVaultAddress
];

await manager.setDexRouters(keys, routers);
await manager.dexRouters("pulsexV2")

const router = await ethers.getContractAt("AffiliateRouter", "0x7872B42710294ce16fEA60575da45Fde51db78e8");

// Address to recieve default fees if user is not referred
await router.setDefaultReferrer("0x137e0A3205023f78535Ed303DAED89FCde8d87c2"); 
await router.defaultReferrer();

await router.setDefaultReferrerBasisPoints(30);
await router.defaultReferrerBasisPoints();

// Withdraw native PLS (ZeroAddress) and WPLS buckets; append ERC-20 addresses to include other tokens
await router.withdrawReferralEarnings([ethers.ZeroAddress, "0xA1077a294dDE1B09bB078844df40758a5D0f9a27"]);

// --- Referral creation gate ---
// Check or update the one-time fee required before creating a referral code.
await router.referralCreationFee();                   // current gate fee in wei
await router.setReferralCreationFee(ethers.parseEther("50")); // owner: set to 50 PLS

// Redirect gate proceeds
await router.referralFeeRecipient();
await router.setReferralFeeRecipient("0xTreasuryWallet");

// Inspect or update the default referral share applied to new wallets
await router.defaultFeeBasisPoints();                 // defaults to 30 (0.30%)
await router.setDefaultFeeBasisPoints(40);            // owner: update global default to 0.40%

// See if a wallet has already paid the creation fee gate
await router.referralCreationFeePaid("0xSomeWallet"); // true/false
```

> Set `.env` `PRIVATE_KEY` to the referrer wallet before running withdrawal commands; the connected signer must own the balance being claimed.

## Project Structure
```
contracts/
  contracts/          # SwapManager, AffiliateRouter, and shared interfaces
  scripts/            # Deployment, upgrade, and routing helpers
  typechain-types/    # Autogenerated TypeScript bindings
  hardhat.config.ts   # Networks, compiler settings, plugins
```

**Key scripts**
| Script | What it does |
|---|---|
| `scripts/deploy-local-proxies.ts` | Deploys fresh SwapManager and AffiliateRouter proxies on Hardhat and wires them together. |
| `scripts/deploy.ts` | Upgrades live proxies, sets DEX routers, and includes sample swap/approval utilities. |
| `scripts/upgrade-affiliate-router-proxy.ts` | Upgrades the AffiliateRouter proxy implementation in place. |
| `scripts/util.ts` | Helper utilities for verification, swap route encoding, and transaction execution. |

## Architecture & Design
- **SwapManager** handles multi-step routes, per-dex router lookups, WPLS wrapping, and grouped percentage splits.
- **AffiliateRouter** enforces referral relationships, basis-point fees, and withdrawal buckets per token.
- **Interfaces** cover PulseX, 9inch, Phux, Tide, and ERC20 semantics for safe external calls.
- **Upgradability** relies on OpenZeppelin `OwnableUpgradeable` + `UUPS` proxies handled through Hardhat upgrades.
- **Safety** features include pausing, reentrancy guards, input validation, and SafeERC20 transfers.

## Testing & Quality
- **Test types:** Not created yet; add unit/integration coverage before shipping changes.
- **Run:** `npx hardhat test`
- **Static checks:** `npx hardhat compile` (solc viaIR, optimizer 200 runs)

## Security & Compliance
- **Secrets:** Managed via `.env` (`dotenv/config`), never commit live keys.
- **Auth:** Owner-only admin on routers and fee configuration; upgrade operations gated to owner.
- **Validation:** Extensive `require` guards on route encodings, percentages, and referral flows.
- **Reentrancy/Pause:** `ReentrancyGuardUpgradeable` and `PausableUpgradeable` protect swap execution and payouts.

## Deployment
- **Environments:** `hardhat` (PulseChain fork), `local` (31337), `pulse` (369 mainnet), `monad` testnet (10143).
- **Proxies:** Managed via OpenZeppelin upgrades (`upgrades.deployProxy`, `upgrades.upgradeProxy`).
- **Verification:** `npx hardhat verify --network pulse 0xE38490Fe9866889b24CA15EBdce6F6ED06f6E8c5`
- **Post-deploy:** Update DEX router addresses and affiliate defaults via Hardhat console or `scripts/deploy.ts`.

## Troubleshooting / FAQ
- **`PRIVATE_KEY` missing or incorrect:** Ensure `.env` contains a funded key before targeting `pulse` or `monad`.
- **Forked RPC timeouts:** Switch to a responsive PulseChain RPC in `hardhat.config.ts` or lower fork polling.
- **Verification fails with `Already Verified`:** Safe to ignore; command exits non-zero but deployment is valid.

## Contributing
- **Workflow:** Branch, implement, run `npx hardhat compile`, and open a PR when ready.
- **Code style:** Follow existing Solidity patterns; keep comments concise and meaningful.
- **Before review:** Document new scripts in this README and provide reproduction steps for regressions.
