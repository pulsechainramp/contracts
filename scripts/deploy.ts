import { ethers, network, upgrades } from "hardhat";
import fs from "fs";
import hre from "hardhat";
import { SwapManager, AffiliateRouter, IERC20 } from "../typechain-types";
import { executeTx, generateSwapRoute, replaceTx, verifyProxyImplementation, waitFor } from "./util";
import { responseData } from "./data";

async function main() {
  console.log("Starting deployments");
  const accounts = await hre.ethers.getSigners();
  const deployer = accounts[0];
  const SwapManagerAddress = "0xE38490Fe9866889b24CA15EBdce6F6ED06f6E8c5";
  const AffiliateRouterAddress = "0x7872B42710294ce16fEA60575da45Fde51db78e8";
  const PhuxVaultAddress = "0x7F51AC3df6A034273FB09BB29e383FCF655e473c";
  const PulseXV1RouterAddress = "0x98bf93ebf5c380C0e6Ae8e192A7e2AE08edAcc02";
  const PulseXV2RouterAddress = "0x165C3410fC91EF562C50559f7d2289fEbed552d9";
  const nineInchV2RouterAddress = "0xeB45a3c4aedd0F47F345fB4c8A1802BB5740d725";
  const nineInchV3RouterAddress = "0x42556A17EF0Bd815bF21aD628DFd2e2f3b5F9ac7";
  const nineMMRouterAddress = "0xa9444246d80d6e3496c9242395213b4f22226a59"
  const dexTopRouterAddress = "0x1f849694Ef24a2245bCa415FE47500216B24d7FF"
  const pDexV3RouterAddress = "0x1eC2eaA62117486c9b2a05F098a7bF2568e19204"
  const TideVaultAddress = "0x634F6B9Cd1f860314871548d2224362825384B2D"
  const eUSDTAddress = "0x0cb6f5a34ad42ec934882a05265a7d5f59b51a2f";

  // const nonce = await deployer.getNonce();
  // console.log("Nonce:", nonce);
  // await replaceTx(deployer, nonce);
  // return;
  console.log("Deployer address:", deployer.address);

  const SwapManagerFactory = await ethers.getContractFactory("SwapManager");
  // const SwapManager = await upgrades.deployProxy(SwapManagerFactory, [])
  // await SwapManager.waitForDeployment()
  // const SwapManager = await upgrades.upgradeProxy(SwapManagerAddress, SwapManagerFactory);
  // await SwapManager.waitForDeployment();
  const SwapManager = SwapManagerFactory.attach(SwapManagerAddress) as SwapManager;
  console.log("SwapManager deployed to:", await SwapManager.getAddress());

  const AffiliateRouterFactory = await ethers.getContractFactory("AffiliateRouter");
  // const AffiliateRouter = await upgrades.deployProxy(AffiliateRouterFactory, [await SwapManager.getAddress()]) as AffiliateRouter;
  // await AffiliateRouter.waitForDeployment()
  const AffiliateRouter = await upgrades.upgradeProxy(AffiliateRouterAddress, AffiliateRouterFactory);
  await AffiliateRouter.waitForDeployment();
  // const AffiliateRouter = AffiliateRouterFactory.attach(AffiliateRouterAddress) as AffiliateRouter;
  console.log("AffiliateRouter deployed to:", await AffiliateRouter.getAddress());

  // await SwapManager.connect(deployer).setAffiliateRouter(await AffiliateRouter.getAddress());
  // console.log("AffiliateRouter set")

  // await waitFor(5);
  // await executeTx(
  //   SwapManager.connect(deployer).setDexRouters(
  //     ["pulsexV1", "pulsexV2", "9inchV2", "9inchV3", "phux", "9mmV3", "9mmV2", "pulsexStable", "dexTop", "pDexV3", "tide"],
  //     [
  //       PulseXV1RouterAddress,
  //       PulseXV2RouterAddress,
  //       nineInchV2RouterAddress,
  //       nineInchV3RouterAddress,
  //       PhuxVaultAddress,
  //       nineMMRouterAddress,
  //       nineMMRouterAddress,
  //       '0x0000000000000000000000000000000000000001',
  //       dexTopRouterAddress,
  //       pDexV3RouterAddress,
  //       TideVaultAddress
  //     ]
  // ));
  // console.log('DexRouters set')

  // const phiatAddress = "0x96E035ae0905EFaC8F733f133462f971Cfa45dB1"
  // const swapRoute: SwapManager.SwapRouteStruct = {
  // 	steps: [{
  // 		dex: 'phux',
  // 		path: [ethers.ZeroAddress, phiatAddress],
  // 		amountIn: ethers.parseEther('1000'),
  // 		amountOutMin: ethers.parseEther('0'),
  // 		pool: "0xD444b7A1d07727a042b61B83Ff3D99e93048F2f4",
  // 		userData: ethers.zeroPadBytes(ethers.toUtf8Bytes('0x'), 32)
  // 	}],
  // 	deadline: Math.floor(Date.now() / 1000 + 1000 * 10).toString()
  // };

	// await waitFor(3);
	// const swapRoute: string = await generateSwapRoute()

  // const eUSDT = await ethers.getContractAt("IERC20", eUSDTAddress) as IERC20;
  // await executeTx(eUSDT.connect(deployer).approve(await AffiliateRouter.getAddress(), ethers.parseUnits("30", 6)))
  // console.log("approved");
  // await executeTx(eUSDT.connect(deployer).transfer("0x8D06b9D1efbcd9b2adCDE0B3aa8f6fA5aF0A219a", ethers.parseUnits("30", 6)))
  // console.log("transferred");

  // const swapRoute = "0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000f4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cb6f5a34ad42ec934882a05265a7d5f59b51a2f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b0000000000000000000000000000000000000000000000000000000068e4f5070000000000000000000000000000000000000000000000000000000001c9c38000000000000000000000000000000000000000000000bccefa2dfab0054800000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000005e0000000000000000000000000000000000000000000000000000000000000078000000000000000000000000000000000000000000000000000000000000009200000000000000000000000000000000000000000000000000000000000000ac00000000000000000000000000000000000000000000000000000000000000c6000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000b107b57264a884a7152402b064e6d4e6b8ae3a2900000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000005396d6d563300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000cb6f5a34ad42ec934882a05265a7d5f59b51a2f000000000000000000000000efd766ccb38eaf1dfd701853bfce31359239f305000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000e56043671df55de5cdf8459710433c10324de0ae00000000000000000000000000000000000000000000000000000000000186a0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000870756c73657856310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000efd766ccb38eaf1dfd701853bfce31359239f305000000000000000000000000a1077a294dde1b09bb078844df40758a5d0f9a27000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000fa41c8cb4d02d1ab4536c27a664cbb8b3c0937a000000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000004706875780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000cb6f5a34ad42ec934882a05265a7d5f59b51a2f00000000000000000000000015d38573d2feeb82e7ad5187ab8c1d52810b1f07000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000d78f85e211db75082bdd3ddcedb15f9f378af24600000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000005396d6d5633000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000015d38573d2feeb82e7ad5187ab8c1d52810b1f07000000000000000000000000efd766ccb38eaf1dfd701853bfce31359239f305000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000e56043671df55de5cdf8459710433c10324de0ae00000000000000000000000000000000000000000000000000000000000186a0000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000870756c73657856310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000efd766ccb38eaf1dfd701853bfce31359239f305000000000000000000000000a1077a294dde1b09bb078844df40758a5d0f9a27000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000b272ae05c5f5ece5a3a599928c06469ebc73fc3100000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000004706875780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000cb6f5a34ad42ec934882a05265a7d5f59b51a2f000000000000000000000000eb6b7932da20c6d7b3a899d5887d86dfb09a6408000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000047ee410999c74b5998808b5009023c08bf8b0caf00000000000000000000000000000000000000000000000000000000000186a0000000000000000000000000000000000000000000000000000000000000000900000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000470687578000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000eb6b7932da20c6d7b3a899d5887d86dfb09a6408000000000000000000000000efd766ccb38eaf1dfd701853bfce31359239f305000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000e56043671df55de5cdf8459710433c10324de0ae00000000000000000000000000000000000000000000000000000000000186a0000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000090000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000870756c73657856310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000efd766ccb38eaf1dfd701853bfce31359239f305000000000000000000000000a1077a294dde1b09bb078844df40758a5d0f9a270000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000013402000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000000000000000004eb5"
  // const referrer = ethers.ZeroAddress;
  // const gas = await (AffiliateRouter.connect(deployer).executeSwap.estimateGas(swapRoute, referrer));
  // console.log('Swap executed')
  // const gas = await AffiliateRouter.connect(deployer).executeSwap.estimateGas(swapRoute, referrer, { value: ethers.parseEther('100000') });
  // console.log('Swap executed')

  // const result = await AffiliateRouter.getReferrerEarnings("0xBcfE4F026844E20236eb886f3cc038154701401F", ethers.ZeroAddress);
  // console.log(result);

  // const address = "0x137e0A3205023f78535Ed303DAED89FCde8d87c2";
  // const result = await AffiliateRouter.getFeeBasisPoints(address);
  // console.log(result);

  // await waitFor(8);
  // await verifyProxyImplementation(await SwapManager.getAddress());
  // await verifyProxyImplementation(await AffiliateRouter.getAddress());
}

// We recommend this pattern to be able to use async/await everywhere
// and properly handle errors.
main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
