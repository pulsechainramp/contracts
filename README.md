# PulseChain Aggregator Contracts
Smart contracts powering PulseChain swap aggregation with referral rewards.

## TL;DR (Quickstart)

```bash
# 1) Install dependencies
cd contracts
npm install

# 2) Generate a throwaway key for local runs (replace before mainnet)
node generateEnv.js

# 3) Compile everything (syncs shared ABIs)
npm run compile

# 4) Spin up local deployments on the in-memory Hardhat network
npx hardhat run scripts/deploy-local.ts --network hardhat
```

**Requirements:** Node.js 20+, npm 10+, Git  
**Deploy to PulseChain:** `npx hardhat run scripts/deploy.ts --network pulse`

## What's Inside (Features)
- **SwapManager aggregation** - Routes swaps across PulseX, 9inch, Phux, Tide, and more using grouped multi-hop encoding.
- **Affiliate incentives** - AffiliateRouter tracks referrers, takes basis-point fees, and pays balances per token bucket.
- **Contract architecture** - Immutable Ownable deployments with owner-only administration and built-in reentrancy guards.


## Installation & Setup

### Prerequisites
- **Runtime:** Node.js 20+
- **Package manager:** npm 10+
- **Infra:** PulseChain RPC endpoint (for `--network pulse` runs)

### Local Development
```bash
npm install
npm run compile
```

### Configuration (ENV)
| Key | Example | Required | Description |
|---|---|:--:|---|
| `PRIVATE_KEY` | `0x0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef` | Yes* | Signer used when targeting `pulse`, `monad`, or `local` networks. |

> *Only needed outside the ephemeral Hardhat network. Keep funds on secure wallets.*

## Usage

### CLI
```bash
npx hardhat run scripts/deploy-local.ts --network pulse
npx hardhat run scripts/deploy.ts --network pulse
npx hardhat console --network pulse
```

### Hardhat console snippets

```javascript
const manager = await ethers.getContractAt("SwapManager", "0xE38490Fe9866889b24CA15EBdce6F6E8c5");
await manager.dexRouters("pulsexV2"); // read-only verification of immutable config
const router = await ethers.getContractAt("AffiliateRouter", "0x7872B42710294ce16fEA60575da45Fde51db78e8");

// Address to recieve default fees if user is not referred
await router.setDefaultReferrer("0x137e0A3205023f78535Ed303DAED89FCde8d87c2"); 
await router.defaultReferrer();

// Withdraw native PLS (ZeroAddress) and WPLS buckets; append ERC-20 addresses to include other tokens
await router.withdrawReferralEarnings([ethers.ZeroAddress, "0xA1077a294dDE1B09bB078844df40758a5D0f9a27"]);

// --- Referral creation gate ---
// Check or update the one-time fee required before creating a referral code.
await router.referralCreationFee();                   // current gate fee in wei (max 100k PLS)
await router.setReferralCreationFee(ethers.parseEther("50")); // owner: set to 50 PLS (<= 100k PLS cap)

// Redirect gate proceeds
await router.referralFeeRecipient();
await router.setReferralFeeRecipient("0xTreasuryWallet");

// Inspect the default referral share applied to new wallets
await router.defaultFeeBasisPoints();                 // defaults to 100 (1.00%)

// Admin-only promo cap; tail is fixed at 1.00% once promos expire
await router.maxPromoBps();                           // defaults to 300 (3.00%)
await router.setMaxPromoBps(200);                     // owner: cap first-three-swaps at 2.00% (1.0%-3.0% allowed)
await router.tailBps();                               // read-only 100 (1.00%) tail cap

// See if a wallet has already paid the creation fee gate
await router.referralCreationFeePaid("0xSomeWallet"); // true/false
```

> Set `.env` `PRIVATE_KEY` to the referrer wallet before running withdrawal commands; the connected signer must own the balance being claimed.

## Project Structure
```
contracts/
  contracts/          # SwapManager, AffiliateRouter, and shared interfaces
  scripts/            # Deployment, upgrade, and routing helpers
  typechain-types/    # Autogenerated TypeScript bindings
  hardhat.config.ts   # Networks, compiler settings, plugins
```

**Key scripts**
| Script | What it does |
|---|---|
| `scripts/deploy-local.ts` | Deploys fresh SwapManager + AffiliateRouter instances on Hardhat and wires them together. |
| `scripts/deploy.ts` | Reconfigures live contracts (set routers, approvals, helper workflows). |
| `scripts/util.ts` | Helper utilities for verification, swap route encoding, and transaction execution. |

## Architecture & Design
- **SwapManager** handles multi-step routes, per-dex router lookups, WPLS wrapping, and grouped percentage splits.
- **AffiliateRouter** enforces referral relationships, basis-point fees, and withdrawal buckets per token.
- **Interfaces** cover PulseX, 9inch, Phux, Tide, and ERC20 semantics for safe external calls.
- **Upgradability** relies on OpenZeppelin `OwnableUpgradeable` + `UUPS` proxies handled through Hardhat upgrades.
- **Safety** features include strict input validation, SafeERC20 transfers, and ReentrancyGuard protection; the router intentionally runs without a pause hook, so incident response relies on UI/API feature flags and new deployments when needed.

## Testing & Quality
- **Test types:** Not created yet; add unit/integration coverage before shipping changes.
- **Run:** `npx hardhat test`
- **Static checks:** `npm run compile` (solc viaIR, optimizer 200 runs + ABI sync)

## Security & Compliance
- **Secrets:** Managed via `.env` (`dotenv/config`), never commit live keys.
- **Auth:** Owner-only admin on routers and fee configuration; upgrade operations gated to owner.
- **Validation:** Extensive `require` guards on route encodings, percentages, and referral flows.
- **Reentrancy:** `ReentrancyGuard` protects swap execution and payouts; there is no on-chain pause switch, so disable flows at the UI/API layer if an incident occurs.

## Deployment
- **Environments:** `hardhat` (PulseChain fork), `local` (31337), `pulse` (369 mainnet), `monad` testnet (10143).
- **Contracts:** Deploy `SwapManager` (passing the WPLS/WETH address) and then `AffiliateRouter` (passing the SwapManager address); wire them via `setAffiliateRouter`.
- **Verification:** `npx hardhat verify --network pulse 0xE38490Fe9866889b24CA15EBdce6F6ED06f6E8c5`
- **Post-deploy:** Update DEX router addresses and affiliate defaults via Hardhat console or `scripts/deploy.ts`.

## Troubleshooting / FAQ
- **`PRIVATE_KEY` missing or incorrect:** Ensure `.env` contains a funded key before targeting `pulse` or `monad`.
- **Forked RPC timeouts:** Switch to a responsive PulseChain RPC in `hardhat.config.ts` or lower fork polling.
- **Verification fails with `Already Verified`:** Safe to ignore; command exits non-zero but deployment is valid.

## Contributing
- **Workflow:** Branch, implement, run `npm run compile` (includes ABI sync), and open a PR when ready.
- **Code style:** Follow existing Solidity patterns; keep comments concise and meaningful.
- **Before review:** Document new scripts in this README and provide reproduction steps for regressions.



